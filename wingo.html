<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WinGo - Professional Betting</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --green: #18b660; --red: #ff4d4d; --violet: #9c27b0; --bg: #f5f5f5; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Arial', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); padding-bottom: 20px; overflow-x: hidden; }

        /* Header & Balance */
        .header-card { background: linear-gradient(to right, #ff4d4d, #ff8a8a); color: white; padding: 25px 20px; text-align: center; border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3); }
        .balance-text { font-size: 32px; font-weight: bold; margin: 10px 0; display: block; }
        .header-btns { display: flex; gap: 15px; justify-content: center; margin-top: 15px; }
        .header-btns button { padding: 10px 30px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }

        /* Game Navigation */
        .game-nav { display: grid; grid-template-columns: repeat(4, 1fr); background: white; margin: 15px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .nav-item { padding: 12px 5px; text-align: center; cursor: pointer; color: #666; font-size: 11px; }
        .nav-item.active { background: #ff4d4d; color: white; font-weight: bold; }
        .nav-item i { display: block; font-size: 22px; margin-bottom: 5px; }

        /* Timer Section */
        .timer-container { background: white; margin: 15px; padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #ff4d4d; }
        .period-info b { font-size: 18px; color: #333; display: block; margin-top: 5px; letter-spacing: 1px; }
        .time-digits { display: flex; gap: 5px; margin-top: 5px; }
        .time-digits div { background: #333; color: #ff4d4d; padding: 8px; border-radius: 5px; font-weight: bold; font-size: 22px; min-width: 35px; text-align: center; }

        /* Betting Board */
        .bet-box { background: white; margin: 15px; padding: 15px; border-radius: 15px; }
        .color-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .color-row button { padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

        .number-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .n-btn { aspect-ratio: 1; border-radius: 50%; border: 2px solid #eee; background: white; font-weight: bold; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .n-btn:active { transform: scale(0.9); }

        .big-small { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .big-small button { padding: 15px; border: none; border-radius: 30px; font-weight: bold; font-size: 18px; color: white; cursor: pointer; }

        /* History Tabs */
        .history-tabs { display: flex; background: white; margin: 15px 15px 0; border-radius: 15px 15px 0 0; border-bottom: 2px solid #eee; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: bold; color: #888; cursor: pointer; }
        .tab-btn.active { color: #ff4d4d; border-bottom: 3px solid #ff4d4d; }

        .history-content { background: white; margin: 0 15px 15px; border-radius: 0 0 15px 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; text-align: center; font-size: 13px; }
        th { padding: 12px; background: #f9f9f9; color: #999; }
        td { padding: 12px; border-bottom: 1px solid #f1f1f1; font-weight: bold; }

        /* Popup Drawer */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; }
        .bet-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: white; border-radius: 25px 25px 0 0; transition: 0.4s; z-index: 1001; padding-bottom: 20px; }
        .bet-sheet.active { bottom: 0; }
        .sheet-header { padding: 25px; text-align: center; color: white; border-radius: 25px 25px 0 0; }
        .sheet-header p { background: white; color: #333; display: inline-block; padding: 6px 25px; border-radius: 20px; font-weight: bold; margin-top: 10px; }

        .sheet-body { padding: 20px; }
        .chip-group { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0 20px; }
        .chip { padding: 10px 15px; background: #f0f0f0; border-radius: 8px; cursor: pointer; font-weight: bold; border: 1px solid transparent; }
        .chip.active { background: var(--active-color, #ff4d4d); color: white; }

        .qty-box { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .qty-btn { width: 40px; height: 40px; border-radius: 8px; border: none; background: #eee; font-size: 24px; cursor: pointer; }
        .qty-input { width: 70px; text-align: center; border: 1px solid #ddd; padding: 10px; border-radius: 8px; font-weight: bold; }

        .confirm-btn { width: 100%; padding: 18px; border: none; color: white; font-weight: bold; font-size: 18px; cursor: pointer; transition: 0.3s; }

        /* 5s Big Timer Overlay */
        .timer-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .big-num { font-size: 180px; color: white; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header-card">
        <span style="opacity: 0.9;">Wallet balance</span>
        <b class="balance-text">৳ <span id="mainBal">0.00</span></b>
        <div class="header-btns">
            <button style="background: white; color: #ff4d4d;">Withdraw</button>
            <button style="background: #18b660; color: white;">Deposit</button>
        </div>
    </div>

    <div class="game-nav">
        <div class="nav-item active" onclick="setGame(30, this)"><i class="fas fa-clock"></i>30s</div>
        <div class="nav-item" onclick="setGame(60, this)"><i class="fas fa-history"></i>1M</div>
        <div class="nav-item" onclick="setGame(180, this)"><i class="fas fa-stopwatch"></i>3M</div>
        <div class="nav-item" onclick="setGame(300, this)"><i class="fas fa-hourglass-half"></i>5M</div>
    </div>

    <div class="timer-container">
        <div class="period-info">Period<b id="periodDisplay">--</b></div>
        <div class="time-box">
            <div class="time-digits">
                <div id="m0">0</div><div id="m1">0</div>
                <span style="font-size: 22px; margin: 5px; color:#333">:</span>
                <div id="s0">0</div><div id="s1">0</div>
            </div>
        </div>
    </div>

    <div class="bet-box">
        <div class="color-row">
            <button style="background: var(--green);" onclick="openBet('Green')">Green</button>
            <button style="background: var(--violet);" onclick="openBet('Violet')">Violet</button>
            <button style="background: var(--red);" onclick="openBet('Red')">Red</button>
        </div>
        <div class="number-grid">
            <button class="n-btn" style="color:var(--violet); border-color:var(--violet)" onclick="openBet(0)">0</button>
            <button class="n-btn" style="color:var(--green);" onclick="openBet(1)">1</button>
            <button class="n-btn" style="color:var(--red);" onclick="openBet(2)">2</button>
            <button class="n-btn" style="color:var(--green);" onclick="openBet(3)">3</button>
            <button class="n-btn" style="color:var(--red);" onclick="openBet(4)">4</button>
            <button class="n-btn" style="color:var(--green);" onclick="openBet(5)">5</button>
            <button class="n-btn" style="color:var(--red);" onclick="openBet(6)">6</button>
            <button class="n-btn" style="color:var(--green);" onclick="openBet(7)">7</button>
            <button class="n-btn" style="color:var(--red);" onclick="openBet(8)">8</button>
            <button class="n-btn" style="color:var(--green);" onclick="openBet(9)">9</button>
        </div>
        <div class="big-small">
            <button style="background: #ffa000;" onclick="openBet('Big')">Big</button>
            <button style="background: #2196f3;" onclick="openBet('Small')">Small</button>
        </div>
    </div>

    <div class="history-tabs">
        <button class="tab-btn active" onclick="switchTab('game', this)">Game History</button>
        <button class="tab-btn" onclick="switchTab('my', this)">My History</button>
    </div>
    <div class="history-content">
        <table id="gameHistoryTable">
            <thead><tr><th>Period</th><th>Number</th><th>Size</th><th>Color</th></tr></thead>
            <tbody id="gameHistoryBody"></tbody>
        </table>
        <table id="myHistoryTable" style="display: none;">
            <thead><tr><th>Period</th><th>Select</th><th>Amount</th><th>Status</th></tr></thead>
            <tbody id="myHistoryBody"></tbody>
        </table>
    </div>

    <div class="overlay" id="overlay" onclick="closeBet()"></div>
    <div class="bet-sheet" id="betSheet">
        <div class="sheet-header" id="sheetHeader">
            <h3 id="sheetTitle">WinGo 30s</h3>
            <p id="selectionText">Select --</p>
        </div>
        <div class="sheet-body">
            <div style="font-weight:bold">Balance</div>
            <div class="chip-group">
                <div class="chip active" onclick="setBase(1, this)">1</div>
                <div class="chip" onclick="setBase(10, this)">10</div>
                <div class="chip" onclick="setBase(100, this)">100</div>
                <div class="chip" onclick="setBase(1000, this)">1000</div>
            </div>
            <div style="font-weight:bold">Quantity</div>
            <div class="qty-box">
                <button class="qty-btn" onclick="updateQty(-1)">-</button>
                <input type="number" id="qtyInput" class="qty-input" value="1" readonly>
                <button class="qty-btn" onclick="updateQty(1)">+</button>
            </div>
            <div style="font-weight:bold">Multiplier</div>
            <div class="chip-group">
                <div class="chip active" onclick="setX(1, this)">X1</div>
                <div class="chip" onclick="setX(5, this)">X5</div>
                <div class="chip" onclick="setX(10, this)">X10</div>
            </div>
        </div>
        <button class="confirm-btn" id="confirmBtn" onclick="confirmBet()">Confirm ৳1.00</button>
    </div>

    <div class="timer-overlay" id="timerOverlay"><div class="big-num" id="bigCountdown">5</div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, serverTimestamp, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://ck-win-36ca8-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let duration = 30;
        let selectedValue = null;
        let baseAmount = 1;
        let multiplier = 1;
        let qty = 1;
        let currentPeriod = "";
        const userKey = localStorage.getItem("userKey");

        // 1. Balance Update
        onValue(ref(db, `users/${userKey}/balance`), (s) => {
            document.getElementById('mainBal').innerText = parseFloat(s.val() || 0).toFixed(2);
        });

        // 2. Real-time Timer
        setInterval(() => {
            const now = new Date();
            const totalSec = (now.getMinutes() * 60) + now.getSeconds();
            const rem = duration - (totalSec % duration);
            currentPeriod = now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0') + Math.floor(totalSec / duration);
            
            document.getElementById('periodDisplay').innerText = currentPeriod;
            document.getElementById('m0').innerText = Math.floor(Math.floor(rem/60)/10);
            document.getElementById('m1').innerText = Math.floor(rem/60)%10;
            document.getElementById('s0').innerText = Math.floor((rem%60)/10);
            document.getElementById('s1').innerText = (rem%60)%10;

            if(rem <= 5) {
                document.getElementById('timerOverlay').style.display = 'flex';
                document.getElementById('bigCountdown').innerText = rem;
                closeBet();
            } else {
                document.getElementById('timerOverlay').style.display = 'none';
            }
        }, 1000);

        // 3. Betting System
        window.openBet = (val) => {
            selectedValue = val;
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('betSheet').classList.add('active');
            document.getElementById('selectionText').innerText = "Select " + val;

            let color = '#18b660';
            if(val === 'Red' || [2,4,6,8].includes(val)) color = '#ff4d4d';
            if(val === 'Violet' || [0,5].includes(val)) color = '#9c27b0';
            if(val === 'Big') color = '#ffa000';
            if(val === 'Small') color = '#2196f3';
            
            document.getElementById('sheetHeader').style.background = color;
            document.getElementById('confirmBtn').style.background = color;
            document.documentElement.style.setProperty('--active-color', color);
            calculateTotal();
        };

        window.closeBet = () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('betSheet').classList.remove('active');
        };

        window.setBase = (a, el) => { baseAmount = a; updateStyles(el); calculateTotal(); };
        window.setX = (x, el) => { multiplier = x; updateStyles(el); calculateTotal(); };
        window.updateQty = (v) => { qty = Math.max(1, qty + v); document.getElementById('qtyInput').value = qty; calculateTotal(); };
        
        function updateStyles(el) {
            el.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }

        function calculateTotal() {
            document.getElementById('confirmBtn').innerText = `Confirm ৳${(baseAmount * multiplier * qty).toFixed(2)}`;
        }

        window.confirmBet = () => {
            const total = baseAmount * multiplier * qty;
            const bal = parseFloat(document.getElementById('mainBal').innerText);
            if(total > bal) return alert("Insufficient Balance!");

            const betData = {
                selection: selectedValue,
                amount: total,
                period: currentPeriod,
                uid: userKey,
                status: "pending",
                time: serverTimestamp()
            };

            set(ref(db, `bets/wingo_${duration}/${currentPeriod}/${userKey}`), betData).then(() => {
                set(ref(db, `users/${userKey}/balance`), bal - total);
                alert("Bet Placed!");
                closeBet();
            });
        };

        // 4. History Handling
        window.switchTab = (type, btn) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('gameHistoryTable').style.display = type === 'game' ? 'table' : 'none';
            document.getElementById('myHistoryTable').style.display = type === 'my' ? 'table' : 'none';
        };

        onValue(query(ref(db, `results/wingo_${duration}`), limitToLast(10)), (snap) => {
            let h = '';
            snap.forEach(c => {
                const d = c.val();
                h = `<tr><td>${c.key}</td><td style="color:${d.color}">${d.number}</td><td>${d.number>=5?'Big':'Small'}</td><td>${d.color}</td></tr>` + h;
            });
            document.getElementById('gameHistoryBody').innerHTML = h;
        });

        // My History auto-load
        onValue(ref(db, `bets/wingo_${duration}`), (snap) => {
            let h = '';
            snap.forEach(period => {
                const myBet = period.val()[userKey];
                if(myBet) {
                    let statusHtml = `<span style="color:orange">Pending</span>`;
                    if(myBet.status === 'win') statusHtml = `<span style="color:green">+৳${(myBet.amount * 1.92).toFixed(2)}</span>`;
                    if(myBet.status === 'loss') statusHtml = `<span style="color:red">-৳${myBet.amount}</span>`;
                    h = `<tr><td>${period.key}</td><td>${myBet.selection}</td><td>৳${myBet.amount}</td><td>${statusHtml}</td></tr>` + h;
                }
            });
            document.getElementById('myHistoryBody').innerHTML = h;
        });

        window.setGame = (d, el) => {
            duration = d;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('sheetTitle').innerText = "WinGo " + d + "s";
        };
    </script>
</body>
</html>
